---
title: "02_pre_processing.Rmd"
author: "Leeya Pressburger"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    fig_caption: yes
    number_sections: yes
    toc: true
    toc_depth: 2
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

### R setup

```{r intro, warning=FALSE, message=FALSE}
library(hector)
library(tidyr)
library(ggplot2)
library(bookdown)
library(data.table) 
library(dplyr)

theme_set(theme_light())

source("common_data.R")

# Read in data files generated by 01_generate_data.Rmd
runlist <- fread("../output/runlist.csv")
model_output <- fread("../output/model_output.csv")
trk_output <- fread("../output/trk_output.csv")

# Add ssp information to the output data
model_output$ssp <- runlist$ssp[model_output$run_number]
trk_output$ssp <- runlist$ssp[trk_output$run_number]

# Read historical NOAA data for comparison graphs
# Comparing outputs to NOAA CO2 data from Mauna Loa observatory
# https://gml.noaa.gov/ccgg/trends/data.html
noaa <- read.csv("../input/noaa_co2_data.csv")
noaa_co2 <- noaa %>% 
  mutate(source = "NOAA") %>%
  filter(year < 2015)

# Define constants
HISTORICAL_CO2_YEARS <- 1959:2014
MAX_FAILFRAC_HISTORICAL <- 0.33
MAX_FAILFRAC_FUTURE <- 0.5

```

### Hector atmospheric CO~2~ vs observed data

``` {r ca-comp, echo = FALSE, fig.cap = " Historical CO2 data from Hector runs and CMIP6 data."}
# This chunk will compare CMIP6 historical CO2 concentration data with 
# Hector data generated by our model runs

# First, we need to read in the CMIP6 data and organize
# Read in CMIP CO2 data, compute summary statistics
cmip_co2_data <- read.csv("../input/CMIP6_annual_co2.csv")

# Isolate historical data
cmip_co2 <- cmip_co2_data %>%
  filter(year %in% HISTORICAL_CO2_YEARS,
         experiment == "historical",
         # Remove models with constant historical CO2
         !(model %in% c("NorESM2-MM", "NorESM2-LM"))) %>%
  mutate(value = value * 1e6,
         units = "ppm") %>%
  group_by(year, model) %>%
  mutate(value = mean(value)) %>%
  group_by(year) %>%
  summarize(sdev = sd(value), 
            med = median(value),
            source = "CMIP6",
            .groups = "drop")

# Identify unrealistic runs - for each Hector run, if more than 33% of values are
# outside of the min/max of the CMIP6 data, the run is removed from the data

# Create bounds using historical data and the standard deviation of the CMIP6 models
cmip_bounds_h <- cmip_co2 %>%
  select(year, sdev, med) %>%
  mutate(hist_mean = noaa_co2$mean,
         minimum = hist_mean - sdev,
         maximum = hist_mean + sdev,
         source = "CMIP6")

# General function to calculate out-of-bounds values and then run failures
run_failures <- function(x, var_name, var_years, 
                                var_min_values, var_max_values, max_out_frac) {
  # Create an observational data frame
  y <- tibble(year = var_years, min_value = var_min_values, max_value = var_max_values)
  # Isolate the matching Hector data, merge with observations, calculate outs 
  # and the run failures (fraction of outs exceeds some limit)
  x %>% 
    filter(variable == var_name, year %in% unique(var_years)) %>% 
    left_join(y, by = "year") %>% 
    mutate(out = value < min_value | value > max_value) %>% 
    group_by(run_number) %>% 
    summarize(fraction_out = sum(out) / n(), .groups = "drop") %>% 
    mutate(fail = fraction_out > max_out_frac)
}

# Summarize
run_fail_summary_new <- run_failures(model_output, "CO2_concentration", 
                                     cmip_bounds_h$year, 
                                     cmip_bounds_h$minimum, 
                                     cmip_bounds_h$maximum, 
                                     max_out_frac = MAX_FAILFRAC_HISTORICAL)

# Plot a random slice of Hector runs, colored by failure, and the CMIP6 bounds
model_output %>% 
  distinct(run_number) %>% 
  slice_sample(n = 100, replace = TRUE) %>% 
  left_join(model_output, by = "run_number") %>%
  filter(variable == "CO2_concentration", 
         year %in% HISTORICAL_CO2_YEARS) %>% 
  left_join(run_fail_summary_new, by = "run_number") %>% 
  ggplot(aes(year, value)) +
  geom_line(aes(group = run_number, color = fraction_out)) +
  geom_point(data = cmip_bounds_h, aes(y = minimum)) +
  geom_point(data = cmip_bounds_h, aes(y = maximum)) +
  # Mauna Loa historical data for comparison
  geom_line(data = noaa_co2, aes(y = mean), color = "red", size = 2) +
  scale_color_distiller(palette = "BrBG") +
  ggtitle("Pre CO2 filtering (dots show CMIP6 bounds; red is observed)")

# Make a table summarizing the run failures
run_fail_summary_new %>% 
  group_by(fail) %>% 
  summarise(N = n(), .groups = "drop") %>% 
  mutate(Percent = round(N / sum(N) * 100, 0),
         Cutoff = MAX_FAILFRAC_HISTORICAL) %>% 
  knitr::kable()

# Filter out 'unrealistic' runs (identified above)
model_output_filtered_1 <- run_fail_summary_new %>%
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(model_output, by = "run_number")

# Remove large data
rm(model_output)

## Plot
# Read in filtered Hector data, compute summary statistics 
hector_co2_summary <- model_output_filtered_1 %>%
  filter(variable == "CO2_concentration",
         year %in% HISTORICAL_CO2_YEARS,
         ssp == MAIN_SCENARIO) %>%
  select(run_number, year, value) %>%
  group_by(year) %>%
  summarize(sdev = sd(value), 
            minimum = min(value),
            maximum = max(value),
            med = median(value),
            source = "Hector",
            .groups = "drop")

# Combine data
plot_data_co2 <- bind_rows(cmip_bounds_h, hector_co2_summary)

# Plot
co2_plot <- plot_data_co2 %>% 
  filter(year < 2015) %>%
  ggplot(aes(year, fill = source, color = source)) +
  geom_ribbon(aes(ymin = minimum, ymax = maximum), alpha = 0.15, color = NA) +
  geom_ribbon(aes(ymin = med - sdev, ymax = med + sdev), alpha = 0.5, color = NA) +
  geom_line(aes(y = med), size = 2) +
  geom_line(data = noaa_co2, aes(year, mean), size = 2) +
  scale_color_manual(breaks = c("CMIP6", "Hector", "NOAA"),
                     values = c("#dfc27d", "#01665e", "#bf812d")) +
  scale_fill_manual(breaks = c("CMIP6", "Hector", "NOAA"),
                    values = c("#dfc27d", "#01665e", "#bf812d")) +
  labs(x = "Year",
       y = expression(Atmospheric~CO[2]~(ppm)),
       color = "Source",
       fill = "Source") +
  scale_x_continuous(expand = c(0, 0)) ; co2_plot

ggsave(plot = co2_plot, "../figures/figure1.png", height = 6, width = 9, units = "in")

```


### Hector temperature vs. CMIP6 

``` {r filtered, warning = FALSE, message = FALSE, echo = FALSE, fig.cap = "Global temperature anomaly from CMIP6 and filtered Hector runs. Lines show median; shaded areas show Â±1 s.d. of median (darker) and minimum and maximum of ensemble (lighter)."}
# This chunk will compare CMIP6 historical and projected global temperature
# anomaly data with Hector data generated by our model runs

# Read in CMIP6 comparison data
cmip_raw <- read.csv("../input/CMIP6_annual_tas_global.csv")

# Isolate historical data
cmip_tgav_hist <- cmip_raw %>% 
  filter(experiment == "historical",
         variable == "Tgav",
         year <= 2100) %>%
  group_by(year) %>%
  summarize(sdev = sd(value),
            minimum = min(value),
            maximum = max(value),
            med = median(value),
            .groups = "drop") %>%
  mutate(source = "CMIP6") 

# Isolate desired scenarios
cmip_tgav_sce <- list()
for(n in names(SSP_files)){
  cmip_tgav_sce[[n]] <- cmip_raw %>% 
    filter(experiment == n)
}  

cmip_sce <- bind_rows(cmip_tgav_sce)
rm(cmip_raw)

# Filter for Tgav and calculate summary metrics
cmip_t_scenarios <- cmip_sce %>%
  rename(ssp = experiment) %>%
  filter(variable == "Tgav",
         year <= 2100) %>%
  group_by(year, ssp) %>%
  summarize(sdev = sd(value),
            minimum = min(value),
            maximum = max(value),
            med = median(value)) %>%
  mutate(source = "CMIP6") %>%
  arrange(ssp, year)

# Need to append the historical values to each SSP
# Add SSP column to historical data, repeat for all scenarios
cmip_hist_repeat_t <- list()
for(n in names(SSP_files)){
  cmip_hist_repeat_t[[n]] <- cmip_tgav_hist %>% 
    mutate(ssp = n)
}
cmip_hist_repeat <- bind_rows(cmip_hist_repeat_t)

cmip_t_final <- bind_rows(cmip_hist_repeat, cmip_t_scenarios) %>% 
  arrange(ssp, year)

### Now that we have all the data we'll need in one place, we want to filter out 
# run numbers twice.
# First, we just want to look at the historical data. Then we'll look at each SSP

# Identify unrealistic historical runs - for each run, if more than 33% of 
# values are outside of the min/max of the CMIP6 data, the run is dropped
cmip_bounds_t <- select(cmip_t_final, ssp, year, minimum, maximum)

cmip_t_historical <- filter(cmip_t_final, year <= 2014)
cmip_t_future <- filter(cmip_t_final, year > 2014)

tgav_h_hist <- run_failures(model_output_filtered_1, "global_tas",
                            cmip_t_historical$year,
                            cmip_t_historical$minimum,
                            cmip_t_historical$maximum,
                            max_out_frac = MAX_FAILFRAC_HISTORICAL)

# Filter out 'unrealistic' runs (identified above)
model_output_filtered_2 <- tgav_h_hist %>%
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(model_output_filtered_1, by = "run_number")

# Remove large data
rm(model_output_filtered_1)

# Repeat for SSPs - future projections
tgav_h_future <- run_failures(model_output_filtered_2, "global_tas",
                              cmip_t_future$year,
                              cmip_t_future$minimum,
                              cmip_t_future$maximum,
                              max_out_frac = MAX_FAILFRAC_FUTURE)

# We'll use this later for visualization
tgav_h_ssp <- model_output_filtered_2 %>%
  filter(variable == "global_tas", year %in% unique(cmip_bounds_t$year)) %>%
  select(run_number, ssp, year, value) %>%
  left_join(cmip_bounds_t, by = c("year", "ssp"))

# Filter out 'unrealistic' runs (identified above)
model_output_final <- tgav_h_future %>%
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(model_output_filtered_2, by = "run_number")

# Remove large data
rm(model_output_filtered_2)

# Create facet labels for plotting
ssp_labels <- c("SSP126", "SSP245", "SSP370", "SSP585")
names(ssp_labels) <- c(names(SSP_runs))

# Plot temperature spreads for each scenario, Hector vs CMIP6
temp_plot <- model_output_final %>%
  filter(variable == "global_tas",
         year >= 1850 & year <= 2100) %>%
  # compute median, min, max, etc. for all remaining runs
  group_by(year, ssp) %>%
  summarize(sdev = sd(value),
            minimum = min(value),
            maximum = max(value),
            med = median(value), .groups = "drop") %>% 
  # combine with CMIP6 data
  mutate(source = "Hector") %>%
  bind_rows(cmip_t_final) %>%
  # ...and plot
  ggplot(aes(year, fill = source, color = source)) +
  geom_ribbon(aes(ymin = minimum, ymax = maximum), alpha = 0.15, color = NA) +
  geom_ribbon(aes(ymin = med - sdev, ymax = med + sdev), alpha = 0.5, color = NA) +
  geom_line(aes(y = med), size = 1) +
  scale_color_manual(breaks = c("CMIP6", "Hector"),
                     values = c("#dfc27d", "#01665e")) +
  scale_fill_manual(breaks = c("CMIP6", "Hector"),
                    values = c("#dfc27d", "#01665e")) +
  facet_wrap(~ssp, scales = "free",
             labeller = labeller(ssp = ssp_labels),
             ncol = 2) +
  labs(x = "Year",
       y = expression(Temperature~anomaly~~(degree*C)),
       color = "Source",
       fill = "Source") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_continuous(expand = c(0, 0)) ; temp_plot

ggsave(plot = temp_plot, "../figures/figure2.png", height = 6, width = 9, units = "in")

```

## Hector temperature vs CMIP6 diagnostic

``` {r s-cmip, message = FALSE, warning = FALSE, fig.cap = " Visualization of sample model runs. The black dots represent the CMIP6 minimums and maximums for global temperature anomaly, and the runs that pass must fall within these bounds more than 50% of the time."}
# Visualize the run fail summaries calculated above
# Make a table of failure rates

# Historical CO2
run_fail_summary_new %>% 
  group_by(fail) %>% 
  summarise(n(), .groups = "drop") %>% 
  knitr::kable()

# Historical temperature
tgav_h_hist %>% 
  group_by(fail) %>% 
  summarise(n(), .groups = "drop") %>% 
  knitr::kable()

# Future temperature
tgav_h_future %>% 
  group_by(fail) %>% 
  summarise(n(), .groups = "drop") %>% 
  knitr::kable()

# ...and a figure 
tgav_h_future %>% 
  # this is a debugging figure; plot just 100 runs for clarity
  slice_sample(n = 100, replace = TRUE) %>% 
  left_join(tgav_h_ssp, by = "run_number") %>%
  filter(year > 2014) %>% 
  ggplot(aes(year, value, color = fraction_out, group = run_number)) + 
  geom_line() + 
  geom_point(aes(y = minimum), color = "black") + 
  geom_point(aes(y = maximum), color = "black") +
  facet_wrap(~ssp,
             labeller = labeller(ssp = ssp_labels),
             ncol = 2) +
  scale_color_distiller(palette = "BrBG") +
  labs(x = "Year",
       y = expression(degree*C),
       color = "Fraction of failed runs")

```

``` {r filter-temp}
# Note that the tracking output needs to be filtered as well
trk_output_filtered_1 <- run_fail_summary_new %>%
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(trk_output, by = "run_number")

# Remove large data and force clear memory
rm(trk_output)

trk_output_filtered_2 <- tgav_h_hist %>% 
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(trk_output_filtered_1, by = "run_number")

rm(trk_output_filtered_1)

trk_output_final <- tgav_h_future %>%
  filter(!fail) %>% 
  select(-fraction_out, -fail) %>% 
  left_join(trk_output_filtered_2, by = "run_number")

rm(trk_output_filtered_2)
gc()
```

``` {r cleanup-cmip, echo = FALSE}
# Write out data, clean environment
fwrite(model_output_final, "../output/model_output_final.csv", row.names = FALSE)
fwrite(trk_output_final, "../output/trk_output_final.csv", row.names = FALSE)

gc()
```
